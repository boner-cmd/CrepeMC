#!/bin/sh

if [ ! -e template ]; then
  echo "No template in current directory." 1>&2 \
    && exit 1
fi

readonly PAPER_BASE_URL="https://papermc.io/api/v2/projects/paper"

PAPER_VERSION="$(curl -LfsS "${PAPER_BASE_URL}" \
  && PAPER_VERSION="$(sed -e 's/.*,"//' -e 's/".*//' <<< $PAPER_VERSION)" \
  && PAPER_VERSION="$(tr -cd 'a-zA-Z0-9.-')" \
  || exit 1

PAPER_BUILD="$(curl -LfsS "${PAPER_BASE_URL}/versions/${PAPER_VERSION}" \
  && PAPER_BUILD="$(sed -e 's/.*,//' -e 's/]}//' <<< $PAPER_BUILD)" \
  && PAPER_BUILD="$(tr -cd 'a-zA-Z0-9.-')" \
  || exit 1

PAPER_SHA256="$(curl -LfsS "${PAPER_BASE_URL}/versions/${PAPER_VERSION}/builds/${PAPER_BUILD}" \
  && PAPER_SHA256="$(sed -e 's/"},"mojang-mappings.*//' -e 's/.*sha256":"//')" \
  && PAPER_SHA256="$(tr -cd 'a-zA-Z0-9.-')" \
  || exit 1

readonly PAPER_FILENAME="paper-${PAPER_VERSION}-${PAPER_BUILD}.jar"
readonly PAPER_FULL_URL="${PAPER_BASE_URL}/${PAPER_VERSION}/builds/${PAPER_BUILD}/downloads/${PAPER_FILENAME}"

JAVA_VERSION="$(https://api.adoptium.net/v3/info/available_releases

if [ ! -d working ]; then
  mkdir working
fi
cp ./template ./working/template
cd working || exit 1

sed -i "s,PAPER_FULL_URL_,${PAPER_FULL_URL},; \
  s,PAPER_FILENAME_,${PAPER_FILENAME},g; \
  s,PAPER_VERSION_,${PAPER_VERSION},; \
  s,JAVA_VERSION_,${JAVA_VERSION},; \
  s,PAPER_SHA256_,${PAPER_SHA256},;" template \
  || exit 1

cat template
exit 0
